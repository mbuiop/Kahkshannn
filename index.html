<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جنگ قبیله‌ای - Tribe Clash</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Tahoma, Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            overflow: hidden;
        }
        #gameCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
        #loadingScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-content { text-align: center; padding: 20px; }
        .loading-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-bar {
            width: 300px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="loadingScreen">
        <div class="loading-content">
            <h1 class="loading-title">⚔️ جنگ قبیله‌ای</h1>
            <p>در حال بارگذاری دنیای حماسی...</p>
            <div class="progress-bar">
                <div id="loadingProgress" class="progress-fill"></div>
            </div>
            <div id="loadingText">۰%</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- ابتدا BabylonJS را بارگذاری کنید -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    
    <!-- سپس فایل‌های بازی را به ترتیب بارگذاری کنید -->
    <script>
        // سیستم مدیریت بارگذاری هوشمند
        const gameFiles = [
            'm1.js',
            'm2.js', 
            'm3.js',
            'm4.js'
        ];
        
        let loadedFiles = 0;
        const totalFiles = gameFiles.length;
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedFiles++;
                    updateProgress();
                    resolve();
                };
                script.onerror = () => {
                    console.error(`خطا در بارگذاری فایل: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }
        
        function updateProgress() {
            const progress = Math.floor((loadedFiles / totalFiles) * 100);
            const progressBar = document.getElementById('loadingProgress');
            const loadingText = document.getElementById('loadingText');
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (loadingText) loadingText.textContent = `بارگذاری فایل‌ها... ${progress}%`;
        }
        
        // بارگذاری مرحله‌ای فایل‌ها
        async function loadGameFiles() {
            try {
                for (const file of gameFiles) {
                    await loadScript(file);
                    // تاخیر برای جلوگیری از بارگذاری همزمان
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // پس از بارگذاری تمام فایل‌ها، بازی را شروع کنید
                setTimeout(() => {
                    if (typeof window.startGame === 'function') {
                        window.startGame();
                    } else {
                        initGame();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('خطا در بارگذاری بازی:', error);
                showError('خطا در بارگذاری فایل‌های بازی');
            }
        }
        
        function initGame() {
            // مخفی کردن صفحه بارگذاری
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // شروع بازی
            if (typeof AdvancedGameEngine !== 'undefined') {
                window.gameEngine = new AdvancedGameEngine();
            } else {
                showError('موتور بازی یافت نشد!');
            }
        }
        
        function showError(message) {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <h2 style="color: #ff4444;">⚠️ خطا</h2>
                        <p>${message}</p>
                        <button onclick="location.reload()" style="
                            padding: 10px 20px;
                            margin-top: 20px;
                            background: #ff4444;
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                        ">تلاش مجدد</button>
                    </div>
                `;
            }
        }
        
        // شروع بارگذاری پس از آماده شدن صفحه
        window.addEventListener('DOMContentLoaded', () => {
            // ابتدا مطمئن شویم BabylonJS بارگذاری شده
            if (typeof BABYLON === 'undefined') {
                showError('BabylonJS بارگذاری نشده است!');
                return;
            }
            
            // سپس فایل‌های بازی را بارگذاری کنید
            loadGameFiles();
        });
    </script>
</body>
</html>
