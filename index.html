<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نبرد کهکشانی - Space War</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: #000;
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }
        #gameContainer { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
        }
        #ui { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            pointer-events: none; 
            z-index: 1000; 
        }
        .screen { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            background: rgba(0, 0, 0, 0.9); 
        }
        .hidden { display: none !important; }
        .hud {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            font-size: 18px;
            text-shadow: 0 0 10px #00ffff;
        }
        .health-bar, .shield-bar {
            width: 200px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 5px 0;
        }
        .health-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #ff0000, #ff4444); 
            width: 100%; 
            transition: width 0.3s; 
        }
        .shield-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #00ffff, #0088ff); 
            width: 100%; 
            transition: width 0.3s; 
        }
        .weapon-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #00ccff, #0066ff);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px #00ccff;
        }
    </style>
</head>
<body>
    <div id="gameContainer"></div>
    <div id="ui">
        <!-- صفحه لودینگ -->
        <div id="loadingScreen" class="screen">
            <h1 style="color: #00ccff; font-size: 48px; margin-bottom: 20px;">نبرد کهکشانی</h1>
            <p style="color: white; font-size: 20px; margin-bottom: 30px;">در حال بارگذاری سیستم‌های جنگنده...</p>
            <div style="width: 300px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden;">
                <div id="loadingBar" style="height: 100%; background: linear-gradient(90deg, #00ccff, #0066ff); width: 0%; transition: width 0.5s;"></div>
            </div>
        </div>

        <!-- منوی اصلی -->
        <div id="mainMenu" class="screen hidden">
            <h1 style="color: #00ccff; font-size: 60px; margin-bottom: 20px; text-shadow: 0 0 20px #00ccff;">SPACE WAR</h1>
            <p style="color: #00ff88; font-size: 24px; margin-bottom: 50px;">نبرد برای بقا در کهکشان</p>
            <button class="btn" id="startBtn">شروع نبرد</button>
            <button class="btn" id="upgradeBtn">ارتقاء جنگنده</button>
            <button class="btn" id="settingsBtn">تنظیمات</button>
        </div>

        <!-- HUD بازی -->
        <div id="gameHUD" class="hidden">
            <div class="hud">
                <div>
                    <div>سلامت: <span id="healthValue">100</span>%</div>
                    <div class="health-bar"><div class="health-fill" id="healthFill"></div></div>
                    <div>محافظ: <span id="shieldValue">100</span>%</div>
                    <div class="shield-bar"><div class="shield-fill" id="shieldFill"></div></div>
                </div>
                <div>
                    <div>امتیاز: <span id="scoreValue">0</span></div>
                    <div>مرحله: <span id="levelValue">1</span></div>
                    <div>دشمنان باقی: <span id="enemiesValue">0</span></div>
                </div>
                <div class="weapon-info">
                    <div>سلاح: <span id="weaponName">لیزر پایه</span></div>
                    <div>ذخیره: <span id="ammoValue">∞</span></div>
                </div>
            </div>
        </div>

        <!-- صفحه پایان بازی -->
        <div id="gameOverScreen" class="screen hidden">
            <h1 style="color: #ff4444; font-size: 48px; margin-bottom: 20px;">ماموریت شکست خورد</h1>
            <p style="color: white; font-size: 24px; margin-bottom: 30px;">جنگنده شما نابود شد</p>
            <div style="color: #00ccff; font-size: 20px; margin-bottom: 30px;">
                <div>امتیاز نهایی: <span id="finalScore">0</span></div>
                <div>مرحله رسیده: <span id="finalLevel">1</span></div>
                <div>دشمنان منهدم: <span id="finalKills">0</span></div>
            </div>
            <button class="btn" id="restartBtn">شروع مجدد</button>
            <button class="btn" id="menuBtn">بازگشت به منو</button>
        </div>
    </div>

    <!-- کتابخانه‌ها -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
        <script>
        // موتور اصلی بازی جنگی فضایی
        class SpaceWarGame {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.clock = new THREE.Clock();
                
                // وضعیت بازی
                this.gameState = 'loading';
                this.currentScreen = 'loadingScreen';
                
                // موجودیت‌های بازی
                this.player = null;
                this.enemies = [];
                this.bullets = [];
                this.particles = [];
                this.stars = [];
                this.planets = [];
                this.asteroids = [];
                
                // آمار بازی
                this.score = 0;
                this.level = 1;
                this.health = 100;
                this.shield = 100;
                this.ammo = 100;
                this.kills = 0;
                
                // کنترل‌ها
                this.keys = {};
                this.mouse = { x: 0, y: 0 };
                
                // تنظیمات
                this.settings = {
                    sensitivity: 1.0,
                    sound: true,
                    graphics: 'high'
                };
                
                this.init();
            }
            
            async init() {
                await this.setupThreeJS();
                this.setupEventListeners();
                this.setupGameWorld();
                this.startLoadingSequence();
            }
            
            async setupThreeJS() {
                // ایجاد صحنه
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000011);
                this.scene.fog = new THREE.Fog(0x000022, 50, 300);
                
                // ایجاد دوربین
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.camera.position.set(0, 5, 15);
                
                // ایجاد رندرر
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true, 
                    powerPreference: "high-performance" 
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                this.renderer.outputEncoding = THREE.sRGBEncoding;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.2;
                
                document.getElementById('gameContainer').appendChild(this.renderer.domElement);
            }
            
            setupLighting() {
                // نور محیطی
                const ambientLight = new THREE.AmbientLight(0x4444ff, 0.3);
                this.scene.add(ambientLight);
                
                // نور جهت‌دار اصلی
                const mainLight = new THREE.DirectionalLight(0xffffff, 1);
                mainLight.position.set(10, 20, 15);
                mainLight.castShadow = true;
                mainLight.shadow.mapSize.width = 2048;
                mainLight.shadow.mapSize.height = 2048;
                this.scene.add(mainLight);
                
                // نور نقطه‌ای برای جلوه‌های ویژه
                const pointLight = new THREE.PointLight(0x00aaff, 2, 100);
                pointLight.position.set(0, 0, 0);
                this.scene.add(pointLight);
                
                // نور برای موتورها
                this.engineLight = new THREE.PointLight(0xff4400, 3, 50);
                this.scene.add(this.engineLight);
            }
            
            createStarfield() {
                const starGeometry = new THREE.BufferGeometry();
                const starCount = 5000;
                const positions = new Float32Array(starCount * 3);
                const colors = new Float32Array(starCount * 3);
                
                for (let i = 0; i < starCount * 3; i += 3) {
                    // موقعیت‌های تصادفی
                    positions[i] = (Math.random() - 0.5) * 2000;
                    positions[i + 1] = (Math.random() - 0.5) * 2000;
                    positions[i + 2] = (Math.random() - 0.5) * 2000;
                    
                    // رنگ‌های تصادفی (ستارگان رنگی)
                    const color = new THREE.Color();
                    color.setHSL(Math.random() * 0.2 + 0.5, 0.8, Math.random() * 0.5 + 0.5);
                    colors[i] = color.r;
                    colors[i + 1] = color.g;
                    colors[i + 2] = color.b;
                }
                
                starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                const starMaterial = new THREE.PointsMaterial({
                    size: 2,
                    sizeAttenuation: true,
                    vertexColors: true,
                    transparent: true,
                    opacity: 0.8
                });
                
                const starField = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(starField);
                this.stars = starField;
            }
            
            createNebulas() {
                // سحابی آبی
                const nebulaGeometry = new THREE.SphereGeometry(80, 32, 32);
                const nebulaMaterial = new THREE.MeshBasicMaterial({
                    color: 0x1e90ff,
                    transparent: true,
                    opacity: 0.05,
                    side: THREE.BackSide
                });
                
                const nebula1 = new THREE.Mesh(nebulaGeometry, nebulaMaterial);
                nebula1.position.set(-100, 50, -200);
                this.scene.add(nebula1);
                
                // سحابی بنفش
                const nebula2 = nebula1.clone();
                nebula2.material = nebulaMaterial.clone();
                nebula2.material.color.set(0x8a2be2);
                nebula2.position.set(150, -30, -300);
                this.scene.add(nebula2);
                
                // سحابی قرمز
                const nebula3 = nebula1.clone();
                nebula3.material = nebulaMaterial.clone();
                nebula3.material.color.set(0xff1493);
                nebula3.position.set(-50, -80, -400);
                this.scene.add(nebula3);
            }
                      createPlayerShip() {
                const shipGroup = new THREE.Group();
                shipGroup.position.set(0, 0, 0);
                
                // بدنه اصلی (مثلثی شکل)
                const bodyGeometry = new THREE.ConeGeometry(1.5, 4, 8);
                const bodyMaterial = new THREE.MeshPhongMaterial({
                    color: 0x4a4a8a,
                    shininess: 100,
                    specular: 0x4444ff,
                    emissive: 0x1a1a3a
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.rotation.x = Math.PI / 2;
                body.castShadow = true;
                shipGroup.add(body);
                
                // کابین خلبان
                const cockpitGeometry = new THREE.SphereGeometry(0.8, 16, 16);
                const cockpitMaterial = new THREE.MeshPhongMaterial({
                    color: 0x87ceeb,
                    transparent: true,
                    opacity: 0.7,
                    shininess: 200,
                    emissive: 0x002244
                });
                const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
                cockpit.position.z = 0.8;
                cockpit.castShadow = true;
                shipGroup.add(cockpit);
                
                // باله‌های جانبی
                const wingGeometry = new THREE.BoxGeometry(4, 0.3, 1.5);
                const wingMaterial = new THREE.MeshPhongMaterial({
                    color: 0x2a2a5a,
                    shininess: 80,
                    emissive: 0x0a0a2a
                });
                
                const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
                leftWing.position.set(-2, 0, -0.5);
                leftWing.castShadow = true;
                shipGroup.add(leftWing);
                
                const rightWing = leftWing.clone();
                rightWing.position.set(2, 0, -0.5);
                shipGroup.add(rightWing);
                
                // موتورها
                this.createEngines(shipGroup);
                
                // سلاح‌ها
                this.createWeapons(shipGroup);
                
                // محافظ انرژی
                this.createShield(shipGroup);
                
                this.player = {
                    mesh: shipGroup,
                    speed: 0.3,
                    rotationSpeed: 0.03,
                    health: 100,
                    shield: 100,
                    weapons: ['laser'],
                    currentWeapon: 'laser',
                    lastShot: 0,
                    shotDelay: 200 // میلی‌ثانیه
                };
                
                this.scene.add(shipGroup);
                return shipGroup;
            }
            
            createEngines(shipGroup) {
                // بدنه موتور
                const engineGeometry = new THREE.CylinderGeometry(0.4, 0.6, 1.5, 8);
                const engineMaterial = new THREE.MeshPhongMaterial({
                    color: 0x8a4a2a,
                    shininess: 50
                });
                
                const leftEngine = new THREE.Mesh(engineGeometry, engineMaterial);
                leftEngine.position.set(-1.2, 0, -1.8);
                leftEngine.rotation.x = Math.PI / 2;
                shipGroup.add(leftEngine);
                
                const rightEngine = leftEngine.clone();
                rightEngine.position.set(1.2, 0, -1.8);
                shipGroup.add(rightEngine);
                
                // شعله موتور
                const flameGeometry = new THREE.ConeGeometry(0.3, 2, 8);
                const flameMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff4500,
                    transparent: true,
                    opacity: 0.8
                });
                
                this.leftFlame = new THREE.Mesh(flameGeometry, flameMaterial);
                this.leftFlame.position.set(-1.2, 0, -2.8);
                this.leftFlame.rotation.x = Math.PI;
                shipGroup.add(this.leftFlame);
                
                this.rightFlame = this.leftFlame.clone();
                this.rightFlame.position.set(1.2, 0, -2.8);
                shipGroup.add(this.rightFlame);
                
                // ذرات موتور
                this.engineParticles = [];
            }
            
            createWeapons(shipGroup) {
                // توپ‌های لیزری
                const gunGeometry = new THREE.CylinderGeometry(0.2, 0.3, 1.2, 8);
                const gunMaterial = new THREE.MeshPhongMaterial({
                    color: 0x8a8a8a,
                    shininess: 120
                });
                
                const leftGun = new THREE.Mesh(gunGeometry, gunMaterial);
                leftGun.position.set(-0.8, 0.5, 1.5);
                leftGun.rotation.x = Math.PI / 2;
                shipGroup.add(leftGun);
                
                const rightGun = leftGun.clone();
                rightGun.position.set(0.8, 0.5, 1.5);
                shipGroup.add(rightGun);
                
                this.weaponPositions = [
                    new THREE.Vector3(-0.8, 0.5, 2.2),
                    new THREE.Vector3(0.8, 0.5, 2.2)
                ];
            }
            
            createShield(shipGroup) {
                const shieldGeometry = new THREE.SphereGeometry(2.5, 32, 32);
                const shieldMaterial = new THREE.MeshBasicMaterial({
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.1,
                    wireframe: true
                });
                
                this.shieldMesh = new THREE.Mesh(shieldGeometry, shieldMaterial);
                shipGroup.add(this.shieldMesh);
            }
            
            updatePlayer(deltaTime) {
                if (!this.player) return;
                
                // حرکت بر اساس کلیدها
                let moveX = 0, moveY = 0;
                
                if (this.keys['ArrowRight'] || this.keys['d']) moveX += 1;
                if (this.keys['ArrowLeft'] || this.keys['a']) moveX -= 1;
                if (this.keys['ArrowUp'] || this.keys['w']) moveY += 1;
                if (this.keys['ArrowDown'] || this.keys['s']) moveY -= 1;
                
                // اعمال حرکت
                this.player.mesh.position.x += moveX * this.player.speed;
                this.player.mesh.position.y += moveY * this.player.speed;
                
                // محدود کردن حرکت به مرزهای صفحه
                const bounds = 8;
                this.player.mesh.position.x = THREE.MathUtils.clamp(this.player.mesh.position.x, -bounds, bounds);
                this.player.mesh.position.y = THREE.MathUtils.clamp(this.player.mesh.position.y, -bounds, bounds);
                
                // چرخش بر اساس حرکت
                const targetRotationX = moveY * 0.3;
                const targetRotationY = moveX * 0.3;
                
                this.player.mesh.rotation.x = THREE.MathUtils.lerp(
                    this.player.mesh.rotation.x, targetRotationX, 0.1
                );
                this.player.mesh.rotation.y = THREE.MathUtils.lerp(
                    this.player.mesh.rotation.y, targetRotationY, 0.1
                );
                
                // انیمیشن شعله موتور
                const flameScale = 1 + Math.sin(Date.now() * 0.02) * 0.3;
                if (this.leftFlame && this.rightFlame) {
                    this.leftFlame.scale.set(1, flameScale, 1);
                    this.rightFlame.scale.set(1, flameScale, 1);
                }
                
                // آپدیت نور موتور
                if (this.engineLight) {
                    this.engineLight.position.copy(this.player.mesh.position);
                    this.engineLight.position.z -= 3;
                }
                
                // آپدیت محافظ
                this.updateShield();
            }
            
            updateShield() {
                if (!this.shieldMesh) return;
                
                const shieldIntensity = this.player.shield / 100;
                this.shieldMesh.material.opacity = 0.05 * shieldIntensity;
                this.shieldMesh.material.color.setHSL(0.5, 1, 0.5 * shieldIntensity);
                
                // انیمیشن چرخش محافظ
                this.shieldMesh.rotation.y += 0.01;
                this.shieldMesh.rotation.x += 0.005;
            }
            
            shoot() {
                const now = Date.now();
                if (now - this.player.lastShot < this.player.shotDelay) return;
                
                this.player.lastShot = now;
                
                // ایجاد تیر برای هر سلاح
                this.weaponPositions.forEach(gunPos => {
                    const worldPos = new THREE.Vector3();
                    this.player.mesh.localToWorld(worldPos.copy(gunPos));
                    
                    this.createBullet(worldPos, new THREE.Vector3(0, 0, 1));
                });
                
                // افکت شلیک
                this.createMuzzleFlash();
            }
            
            createBullet(position, direction) {
                const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const bulletMaterial = new THREE.MeshBasicMaterial({
                    color: 0x00ffff,
                    emissive: 0x0088ff
                });
                
                const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                bullet.position.copy(position);
                
                this.scene.add(bullet);
                
                this.bullets.push({
                    mesh: bullet,
                    velocity: direction.multiplyScalar(1.5),
                    damage: 10,
                    lifetime: 3000 // 3 ثانیه
                });
                
                // افکت نور تیر
                const light = new THREE.PointLight(0x00aaff, 2, 10);
                bullet.add(light);
            }
            
            createMuzzleFlash() {
                const flashGeometry = new THREE.SphereGeometry(0.3, 8, 8);
                const flashMaterial = new THREE.MeshBasicMaterial({
                    color: 0xffff00,
                    transparent: true,
                    opacity: 0.8
                });
                
                this.weaponPositions.forEach(gunPos => {
                    const flash = new THREE.Mesh(flashGeometry, flashMaterial);
                    const worldPos = new THREE.Vector3();
                    this.player.mesh.localToWorld(worldPos.copy(gunPos));
                    flash.position.copy(worldPos);
                    
                    this.scene.add(flash);
                    
                    // انیمیشن محو شدن فلش
                    gsap.to(flash.scale, {
                        x: 2, y: 2, z: 2, duration: 0.1
                    });
                    gsap.to(flash.material, {
                        opacity: 0, duration: 0.2,
                        onComplete: () => {
                            this.scene.remove(flash);
                        }
                    });
                });
            }
            
            updateBullets(deltaTime) {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    // حرکت تیر
                    bullet.mesh.position.add(bullet.velocity.clone().multiplyScalar(deltaTime * 60));
                    
                    // کاهش عمر
                    bullet.lifetime -= deltaTime * 1000;
                    
                    // حذف تیرهای قدیمی
                    if (bullet.lifetime <= 0 || bullet.mesh.position.z > 50) {
                        this.scene.remove(bullet.mesh);
                        this.bullets.splice(i, 1);
                        continue;
                    }
                    
                    // بررسی برخورد با دشمنان
                    this.checkBulletCollisions(bullet, i);
                }
          }
                      createEnemy(type = 'scout', position = null) {
                if (!position) {
                    position = new THREE.Vector3(
                        (Math.random() - 0.5) * 30,
                        (Math.random() - 0.5) * 20,
                        -50 - Math.random() * 50
                    );
                }

                const enemyGroup = new THREE.Group();
                enemyGroup.position.copy(position);

                let health, speed, color, size;

                switch(type) {
                    case 'scout':
                        health = 30;
                        speed = 0.4;
                        color = 0xff4444;
                        size = 1.2;
                        break;
                    case 'fighter':
                        health = 60;
                        speed = 0.3;
                        color = 0xffaa00;
                        size = 1.8;
                        break;
                    case 'cruiser':
                        health = 120;
                        speed = 0.2;
                        color = 0xff00ff;
                        size = 2.5;
                        break;
                    case 'boss':
                        health = 300;
                        speed = 0.15;
                        color = 0x00ffff;
                        size = 4;
                        break;
                }

                // بدنه دشمن
                const bodyGeometry = new THREE.OctahedronGeometry(size);
                const bodyMaterial = new THREE.MeshPhongMaterial({
                    color: color,
                    shininess: 80,
                    emissive: new THREE.Color(color).multiplyScalar(0.3)
                });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.castShadow = true;
                enemyGroup.add(body);

                // سلاح دشمن
                const gunGeometry = new THREE.CylinderGeometry(0.1, 0.15, 0.8, 8);
                const gunMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
                
                const leftGun = new THREE.Mesh(gunGeometry, gunMaterial);
                leftGun.position.set(-0.5, 0, 0.8);
                leftGun.rotation.x = Math.PI / 2;
                enemyGroup.add(leftGun);
                
                const rightGun = leftGun.clone();
                rightGun.position.set(0.5, 0, 0.8);
                enemyGroup.add(rightGun);

                const enemy = {
                    mesh: enemyGroup,
                    type: type,
                    health: health,
                    maxHealth: health,
                    speed: speed,
                    lastShot: 0,
                    shotDelay: 1000 + Math.random() * 1000,
                    attackRange: 25,
                    state: 'approaching', // approaching, attacking, fleeing
                    targetPosition: new THREE.Vector3(),
                    movePattern: Math.floor(Math.random() * 3),
                    value: type === 'scout' ? 10 : type === 'fighter' ? 25 : type === 'cruiser' ? 50 : 100
                };

                this.enemies.push(enemy);
                this.scene.add(enemyGroup);

                // نور قرمز برای دشمن
                const enemyLight = new THREE.PointLight(color, 1, 15);
                enemyGroup.add(enemyLight);

                return enemy;
            }

            updateEnemies(deltaTime) {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    
                    if (!this.player) continue;

                    // محاسبه فاصله تا بازیکن
                    const distanceToPlayer = enemy.mesh.position.distanceTo(this.player.mesh.position);

                    // هوش مصنوعی دشمن
                    this.updateEnemyAI(enemy, distanceToPlayer, deltaTime);

                    // حرکت دشمن
                    this.updateEnemyMovement(enemy, deltaTime);

                    // شلیک دشمن
                    this.updateEnemyShooting(enemy, distanceToPlayer, deltaTime);

                    // بررسی مرگ دشمن
                    if (enemy.health <= 0) {
                        this.destroyEnemy(enemy, i);
                        continue;
                    }

                    // حذف دشمنان دور
                    if (enemy.mesh.position.z > 20) {
                        this.scene.remove(enemy.mesh);
                        this.enemies.splice(i, 1);
                    }
                }
            }

            updateEnemyAI(enemy, distanceToPlayer, deltaTime) {
                const playerPos = this.player.mesh.position;

                switch(enemy.state) {
                    case 'approaching':
                        // حرکت به سمت بازیکن
                        enemy.targetPosition.copy(playerPos);
                        enemy.targetPosition.z += 5; // توقف در فاصله

                        if (distanceToPlayer < enemy.attackRange) {
                            enemy.state = 'attacking';
                        }
                        break;

                    case 'attacking':
                        // مانور برای حمله
                        const time = Date.now() * 0.001;
                        
                        switch(enemy.movePattern) {
                            case 0: // حرکت دایره‌ای
                                enemy.targetPosition.x = playerPos.x + Math.cos(time) * 8;
                                enemy.targetPosition.y = playerPos.y + Math.sin(time) * 5;
                                enemy.targetPosition.z = playerPos.z + 3;
                                break;
                            case 1: // حرکت زیگزاگ
                                enemy.targetPosition.x = playerPos.x + Math.sin(time * 2) * 6;
                                enemy.targetPosition.y = playerPos.y;
                                enemy.targetPosition.z = playerPos.z + 4;
                                break;
                            case 2: // حرکت عمودی
                                enemy.targetPosition.x = playerPos.x;
                                enemy.targetPosition.y = playerPos.y + Math.sin(time * 1.5) * 4;
                                enemy.targetPosition.z = playerPos.z + 3;
                                break;
                        }

                        // فرار در صورت آسیب زیاد
                        if (enemy.health < enemy.maxHealth * 0.3) {
                            enemy.state = 'fleeing';
                        }
                        break;

                    case 'fleeing':
                        // فرار از بازیکن
                        enemy.targetPosition.copy(playerPos);
                        enemy.targetPosition.multiplyScalar(-1);
                        enemy.targetPosition.normalize();
                        enemy.targetPosition.multiplyScalar(50);
                        break;
                }
            }

            updateEnemyMovement(enemy, deltaTime) {
                // حرکت به سمت موقعیت هدف
                const direction = new THREE.Vector3();
                direction.subVectors(enemy.targetPosition, enemy.mesh.position);
                
                if (direction.length() > 1) {
                    direction.normalize();
                    enemy.mesh.position.add(direction.multiplyScalar(enemy.speed * deltaTime * 60));
                }

                // چرخش به سمت بازیکن
                enemy.mesh.lookAt(this.player.mesh.position);

                // انیمیشن حرکت
                const bob = Math.sin(Date.now() * 0.005) * 0.1;
                enemy.mesh.position.y += bob * deltaTime;
            }

            updateEnemyShooting(enemy, distanceToPlayer, deltaTime) {
                if (distanceToPlayer > enemy.attackRange) return;

                const now = Date.now();
                if (now - enemy.lastShot < enemy.shotDelay) return;

                enemy.lastShot = now;

                // شلیک به سمت بازیکن
                const direction = new THREE.Vector3();
                direction.subVectors(this.player.mesh.position, enemy.mesh.position);
                direction.normalize();

                this.createEnemyBullet(enemy.mesh.position, direction, enemy.type);
            }

            createEnemyBullet(position, direction, type) {
                let color, damage, speed;

                switch(type) {
                    case 'scout':
                        color = 0xff4444;
                        damage = 5;
                        speed = 0.8;
                        break;
                    case 'fighter':
                        color = 0xffaa00;
                        damage = 10;
                        speed = 0.7;
                        break;
                    case 'cruiser':
                        color = 0xff00ff;
                        damage = 15;
                        speed = 0.6;
                        break;
                    case 'boss':
                        color = 0x00ffff;
                        damage = 25;
                        speed = 0.5;
                        break;
                }

                const bulletGeometry = new THREE.SphereGeometry(0.15, 8, 8);
                const bulletMaterial = new THREE.MeshBasicMaterial({
                    color: color,
                    emissive: color
                });

                const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                bullet.position.copy(position);
                
                this.scene.add(bullet);

                this.bullets.push({
                    mesh: bullet,
                    velocity: direction.multiplyScalar(speed),
                    damage: damage,
                    lifetime: 4000,
                    isEnemy: true
                });

                // افکت شلیک دشمن
                this.createEnemyMuzzleFlash(position);
            }

            createEnemyMuzzleFlash(position) {
                const flashGeometry = new THREE.SphereGeometry(0.4, 8, 8);
                const flashMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.8
                });

                const flash = new THREE.Mesh(flashGeometry, flashMaterial);
                flash.position.copy(position);
                
                this.scene.add(flash);

                gsap.to(flash.scale, { x: 1.5, y: 1.5, z: 1.5, duration: 0.1 });
                gsap.to(flash.material, {
                    opacity: 0, duration: 0.2,
                    onComplete: () => {
                        this.scene.remove(flash);
                    }
                });
            }

            checkBulletCollisions(bullet, bulletIndex) {
                if (bullet.isEnemy) {
                    // برخورد با بازیکن
                    if (this.player && bullet.mesh.position.distanceTo(this.player.mesh.position) < 2) {
                        this.playerHit(bullet.damage);
                        this.createExplosion(bullet.mesh.position, 0xff4444);
                        this.scene.remove(bullet.mesh);
                        this.bullets.splice(bulletIndex, 1);
                    }
                } else {
                    // برخورد با دشمنان
                    for (let i = this.enemies.length - 1; i >= 0; i--) {
                        const enemy = this.enemies[i];
                        
                        if (bullet.mesh.position.distanceTo(enemy.mesh.position) < 2) {
                            enemy.health -= bullet.damage;
                            this.createHitEffect(bullet.mesh.position);
                            
                            // آپدیت سلامت دشمن
                            this.updateEnemyHealthBar(enemy);
                            
                            this.scene.remove(bullet.mesh);
                            this.bullets.splice(bulletIndex, 1);
                            break;
                        }
                    }
                }
            }

            updateEnemyHealthBar(enemy) {
                // ایجاد یا آپدیت نوار سلامت دشمن
                if (!enemy.healthBar) {
                    const healthBarGeometry = new THREE.PlaneGeometry(2, 0.2);
                    const healthBarMaterial = new THREE.MeshBasicMaterial({
                        color: 0x00ff00,
                        side: THREE.DoubleSide
                    });
                    
                    enemy.healthBar = new THREE.Mesh(healthBarGeometry, healthBarMaterial);
                    enemy.healthBar.position.y = 2;
                    enemy.mesh.add(enemy.healthBar);
                }

                const healthPercent = enemy.health / enemy.maxHealth;
                enemy.healthBar.scale.x = healthPercent;
                
                // تغییر رنگ بر اساس سلامت
                if (healthPercent > 0.6) {
                    enemy.healthBar.material.color.set(0x00ff00);
                } else if (healthPercent > 0.3) {
                    enemy.healthBar.material.color.set(0xffff00);
                } else {
                    enemy.healthBar.material.color.set(0xff0000);
                }
            }

            destroyEnemy(enemy, index) {
                // ایجاد انفجار
                this.createExplosion(enemy.mesh.position, 0xffaa00, 2);
                
                // افزایش امتیاز
                this.score += enemy.value;
                this.kills++;
                
                // ایجاد آیتم‌های قابل جمع‌آوری
                this.createPowerUp(enemy.mesh.position);
                
                // حذف از صحنه
                this.scene.remove(enemy.mesh);
                this.enemies.splice(index, 1);
                
                // آپدیت رابط کاربری
                this.updateHUD();
            }

            playerHit(damage) {
                // کاهش محافظ اول
                if (this.player.shield > 0) {
                    this.player.shield -= damage;
                    if (this.player.shield < 0) {
                        this.player.health += this.player.shield; // آسیب اضافی به سلامت
                        this.player.shield = 0;
                    }
                } else {
                    this.player.health -= damage;
                }

                // لرزش دوربین
                this.cameraShake(0.5);

                // افکت آسیب
                this.createDamageEffect();

                // بررسی مرگ بازیکن
                if (this.player.health <= 0) {
                    this.gameOver();
                }

                this.updateHUD();
            }

            cameraShake(intensity) {
                const originalPosition = this.camera.position.clone();
                
                gsap.to(this.camera.position, {
                    x: originalPosition.x + (Math.random() - 0.5) * intensity,
                    y: originalPosition.y + (Math.random() - 0.5) * intensity,
                    z: originalPosition.z + (Math.random() - 0.5) * intensity,
                    duration: 0.1,
                    yoyo: true,
                    repeat: 1,
                    onComplete: () => {
                        this.camera.position.copy(originalPosition);
                    }
                });
  }
                      createExplosion(position, color = 0xffaa00, size = 1) {
                // ایجاد نور انفجار
                const explosionLight = new THREE.PointLight(color, 5, 20);
                explosionLight.position.copy(position);
                this.scene.add(explosionLight);

                // انیمیشن نور
                gsap.to(explosionLight, {
                    intensity: 0,
                    duration: 0.5,
                    onComplete: () => {
                        this.scene.remove(explosionLight);
                    }
                });

                // ایجاد ذرات انفجار
                const particleCount = 30;
                const particles = [];

                for (let i = 0; i < particleCount; i++) {
                    const particleGeometry = new THREE.SphereGeometry(0.1 * size, 4, 4);
                    const particleMaterial = new THREE.MeshBasicMaterial({
                        color: color,
                        transparent: true,
                        opacity: 0.8
                    });

                    const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                    particle.position.copy(position);

                    // سرعت تصادفی در همه جهات
                    const velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2,
                        (Math.random() - 0.5) * 2
                    ).normalize().multiplyScalar(Math.random() * 3 + 1);

                    const life = 1 + Math.random() * 0.5;

                    particles.push({
                        mesh: particle,
                        velocity: velocity,
                        life: life,
                        maxLife: life
                    });

                    this.scene.add(particle);
                }

                // اضافه کردن به سیستم پارتیکل
                this.particles.push(...particles);

                // ایجاد موج شوک
                this.createShockwave(position, color);
            }

            createShockwave(position, color) {
                const shockwaveGeometry = new THREE.RingGeometry(0.1, 1, 32);
                const shockwaveMaterial = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.6,
                    side: THREE.DoubleSide
                });

                const shockwave = new THREE.Mesh(shockwaveGeometry, shockwaveMaterial);
                shockwave.position.copy(position);
                shockwave.rotation.x = Math.PI / 2;
                this.scene.add(shockwave);

                // انیمیشن موج شوک
                gsap.to(shockwave.scale, {
                    x: 8,
                    y: 8,
                    z: 8,
                    duration: 0.8,
                    ease: "power2.out"
                });

                gsap.to(shockwave.material, {
                    opacity: 0,
                    duration: 0.8,
                    onComplete: () => {
                        this.scene.remove(shockwave);
                    }
                });
            }

            createHitEffect(position) {
                // ایجاد جرقه برخورد
                const sparkCount = 8;
                
                for (let i = 0; i < sparkCount; i++) {
                    const sparkGeometry = new THREE.SphereGeometry(0.05, 4, 4);
                    const sparkMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffff00,
                        transparent: true,
                        opacity: 0.8
                    });

                    const spark = new THREE.Mesh(sparkGeometry, sparkMaterial);
                    spark.position.copy(position);

                    const velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 0.5,
                        (Math.random() - 0.5) * 0.5,
                        (Math.random() - 0.5) * 0.5
                    ).normalize().multiplyScalar(Math.random() * 1 + 0.5);

                    this.particles.push({
                        mesh: spark,
                        velocity: velocity,
                        life: 0.3,
                        maxLife: 0.3
                    });

                    this.scene.add(spark);
                }
            }

            createDamageEffect() {
                // ایجاد افکت آسیب بصری (لرزش و رنگ قرمز)
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.background = 'rgba(255, 0, 0, 0.3)';
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '999';
                
                document.getElementById('ui').appendChild(overlay);

                gsap.to(overlay, {
                    opacity: 0,
                    duration: 0.5,
                    onComplete: () => {
                        document.getElementById('ui').removeChild(overlay);
                    }
                });
            }

            updateParticles(deltaTime) {
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    
                    // حرکت ذره
                    particle.mesh.position.add(particle.velocity.clone().multiplyScalar(deltaTime * 60));
                    
                    // کاهش عمر
                    particle.life -= deltaTime;
                    
                    // محو شدن تدریجی
                    const lifePercent = particle.life / particle.maxLife;
                    particle.mesh.material.opacity = lifePercent * 0.8;
                    
                    // کاهش اندازه
                    particle.mesh.scale.setScalar(lifePercent);
                    
                    // حذف ذرات مرده
                    if (particle.life <= 0) {
                        this.scene.remove(particle.mesh);
                        this.particles.splice(i, 1);
                    }
                }
            }

            createPowerUp(position) {
                // شانس ایجاد آیتم (30%)
                if (Math.random() > 0.3) return;

                const types = ['health', 'shield', 'ammo', 'weapon'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                let color, geometry;

                switch(type) {
                    case 'health':
                        color = 0xff4444;
                        geometry = new THREE.OctahedronGeometry(0.5);
                        break;
                    case 'shield':
                        color = 0x00aaff;
                        geometry = new THREE.IcosahedronGeometry(0.5);
                        break;
                    case 'ammo':
                        color = 0xffff00;
                        geometry = new THREE.BoxGeometry(0.6, 0.6, 0.6);
                        break;
                    case 'weapon':
                        color = 0x00ff00;
                        geometry = new THREE.ConeGeometry(0.4, 1, 8);
                        break;
                }

                const material = new THREE.MeshPhongMaterial({
                    color: color,
                    emissive: color,
                    emissiveIntensity: 0.5,
                    shininess: 100
                });

                const powerUp = new THREE.Mesh(geometry, material);
                powerUp.position.copy(position);

                // نور آیتم
                const light = new THREE.PointLight(color, 2, 8);
                powerUp.add(light);

                this.scene.add(powerUp);

                this.powerUps.push({
                    mesh: powerUp,
                    type: type,
                    life: 10, // 10 ثانیه
                    rotationSpeed: 0.02
                });
            }

            updatePowerUps(deltaTime) {
                for (let i = this.powerUps.length - 1; i >= 0; i--) {
                    const powerUp = this.powerUps[i];
                    
                    // چرخش آیتم
                    powerUp.mesh.rotation.y += powerUp.rotationSpeed;
                    powerUp.mesh.rotation.x += powerUp.rotationSpeed * 0.5;
                    
                    // حرکت شناور
                    powerUp.mesh.position.y += Math.sin(Date.now() * 0.005) * 0.01;
                    
                    // کاهش عمر
                    powerUp.life -= deltaTime;
                    
                    // بررسی جمع‌آوری توسط بازیکن
                    if (this.player && powerUp.mesh.position.distanceTo(this.player.mesh.position) < 2) {
                        this.collectPowerUp(powerUp, i);
                        continue;
                    }
                    
                    // حذف آیتم منقضی شده
                    if (powerUp.life <= 0) {
                        this.scene.remove(powerUp.mesh);
                        this.powerUps.splice(i, 1);
                    }
                }
            }

            collectPowerUp(powerUp, index) {
                // افکت جمع‌آوری
                this.createCollectionEffect(powerUp.mesh.position, powerUp.mesh.material.color);
                
                // اعمال اثر آیتم
                switch(powerUp.type) {
                    case 'health':
                        this.player.health = Math.min(100, this.player.health + 25);
                        break;
                    case 'shield':
                        this.player.shield = Math.min(100, this.player.shield + 30);
                        break;
                    case 'ammo':
                        this.ammo += 50;
                        break;
                    case 'weapon':
                        this.upgradeWeapon();
                        break;
                }
                
                // حذف آیتم
                this.scene.remove(powerUp.mesh);
                this.powerUps.splice(index, 1);
                
                this.updateHUD();
            }

            createCollectionEffect(position, color) {
                // ایجاد افکت جمع‌آوری (حلقه‌های درخشان)
                const ringGeometry = new THREE.RingGeometry(0.5, 1, 16);
                const ringMaterial = new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.8,
                    side: THREE.DoubleSide
                });

                for (let i = 0; i < 3; i++) {
                    const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                    ring.position.copy(position);
                    ring.rotation.x = Math.PI / 2;
                    this.scene.add(ring);

                    gsap.to(ring.scale, {
                        x: 3,
                        y: 3,
                        z: 3,
                        duration: 0.6,
                        delay: i * 0.1
                    });

                    gsap.to(ring.material, {
                        opacity: 0,
                        duration: 0.6,
                        delay: i * 0.1,
                        onComplete: () => {
                            this.scene.remove(ring);
                        }
                    });
                }
            }

            upgradeWeapon() {
                const weapons = ['laser', 'plasma', 'railgun', 'quantum'];
                const currentIndex = weapons.indexOf(this.player.currentWeapon);
                
                if (currentIndex < weapons.length - 1) {
                    this.player.currentWeapon = weapons[currentIndex + 1];
                    this.player.shotDelay = Math.max(50, this.player.shotDelay - 50);
                    
                    // افکت ارتقاء سلاح
                    this.createUpgradeEffect();
                }
            }

            createUpgradeEffect() {
                // ایجاد افکت ارتقاء در اطراف جنگنده
                const effectGeometry = new THREE.TorusGeometry(3, 0.1, 8, 32);
                const effectMaterial = new THREE.MeshBasicMaterial({
                    color: 0x00ff00,
                    transparent: true,
                    opacity: 0.6
                });

                const effect = new THREE.Mesh(effectGeometry, effectMaterial);
                effect.position.copy(this.player.mesh.position);
                this.scene.add(effect);

                gsap.to(effect.scale, {
                    x: 1.5,
                    y: 1.5,
                    z: 1.5,
                    duration: 1
                });

                gsap.to(effect.material, {
                    opacity: 0,
                    duration: 1,
                    onComplete: () => {
                        this.scene.remove(effect);
                    }
                });
            }

            spawnAsteroids() {
                // ایجاد سیارک‌های تصادفی در صحنه
                const asteroidCount = 20;
                
                for (let i = 0; i < asteroidCount; i++) {
                    const size = Math.random() * 2 + 0.5;
                    const geometry = new THREE.DodecahedronGeometry(size, 0);
                    const material = new THREE.MeshPhongMaterial({
                        color: 0x8a6d3b,
                        shininess: 30
                    });

                    const asteroid = new THREE.Mesh(geometry, material);
                    
                    // موقعیت تصادفی
                    asteroid.position.set(
                        (Math.random() - 0.5) * 100,
                        (Math.random() - 0.5) * 80,
                        -50 - Math.random() * 200
                    );

                    // چرخش تصادفی
                    asteroid.rotation.set(
                        Math.random() * Math.PI,
                        Math.random() * Math.PI,
                        Math.random() * Math.PI
                    );

                    this.scene.add(asteroid);
                    
                    this.asteroids.push({
                        mesh: asteroid,
                        rotationSpeed: new THREE.Vector3(
                            (Math.random() - 0.5) * 0.01,
                            (Math.random() - 0.5) * 0.01,
                            (Math.random() - 0.5) * 0.01
                        )
                    });
                }
            }

            updateAsteroids(deltaTime) {
                for (let asteroid of this.asteroids) {
                    // چرخش سیارک
                    asteroid.mesh.rotation.x += asteroid.rotationSpeed.x;
                    asteroid.mesh.rotation.y += asteroid.rotationSpeed.y;
                    asteroid.mesh.rotation.z += asteroid.rotationSpeed.z;
                    
                    // حرکت آرام به سمت جلو
                    asteroid.mesh.position.z += 0.1 * deltaTime * 60;
                    
                    // بازگرداندن سیارک‌های دور
                    if (asteroid.mesh.position.z > 20) {
                        asteroid.mesh.position.z = -200;
                        asteroid.mesh.position.x = (Math.random() - 0.5) * 100;
                        asteroid.mesh.position.y = (Math.random() - 0.5) * 80;
                    }
                }
  }
                      setupGameWorld() {
                this.setupLighting();
                this.createStarfield();
                this.createNebulas();
                this.createPlayerShip();
                this.spawnAsteroids();
                this.setupAudio();
                
                this.waveManager = new WaveManager(this);
                this.powerUps = [];
                
                this.gameLoop();
            }

            setupEventListeners() {
                // کنترل‌های کیبورد
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key.toLowerCase()] = true;
                    
                    if (e.key === ' ' && this.gameState === 'playing') {
                        this.shoot();
                    }
                    
                    if (e.key === 'Escape') {
                        this.togglePause();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });

                // کنترل‌های ماوس
                document.addEventListener('mousemove', (e) => {
                    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                });

                document.addEventListener('click', () => {
                    if (this.gameState === 'playing') {
                        this.shoot();
                    }
                });

                // دکمه‌های رابط کاربری
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startGame();
                });

                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restartGame();
                });

                document.getElementById('menuBtn').addEventListener('click', () => {
                    this.showMainMenu();
                });

                // رسپانسیو
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            startLoadingSequence() {
                let progress = 0;
                const loadingSteps = [
                    'بارگذاری موتور گرافیکی...',
                    'راه‌اندازی سیستم ذرات...',
                    'آماده‌سازی محیط بازی...',
                    'راه‌اندازی سیستم صوتی...',
                    'بارگذاری مدل‌ها...',
                    'آماده‌سازی دشمنان...'
                ];

                const interval = setInterval(() => {
                    progress += 100 / loadingSteps.length;
                    document.getElementById('loadingBar').style.width = progress + '%';
                    
                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                            this.showMainMenu();
                        }, 1000);
                    }
                }, 500);
            }

            startGame() {
                this.gameState = 'playing';
                this.currentScreen = 'gameHUD';
                
                this.score = 0;
                this.level = 1;
                this.health = 100;
                this.shield = 100;
                this.ammo = 100;
                this.kills = 0;
                
                this.hideAllScreens();
                document.getElementById('gameHUD').classList.remove('hidden');
                
                this.waveManager.startWave(1);
                this.updateHUD();
            }

            gameOver() {
                this.gameState = 'gameOver';
                this.currentScreen = 'gameOverScreen';
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalLevel').textContent = this.level;
                document.getElementById('finalKills').textContent = this.kills;
                
                this.hideAllScreens();
                document.getElementById('gameOverScreen').classList.remove('hidden');
                
                // ایجاد انفجار بزرگ
                this.createExplosion(this.player.mesh.position, 0xff0000, 3);
            }

            restartGame() {
                // پاک کردن صحنه
                while(this.scene.children.length > 0) { 
                    this.scene.remove(this.scene.children[0]); 
                }
                
                // ریست کردن آرایه‌ها
                this.enemies = [];
                this.bullets = [];
                this.particles = [];
                this.powerUps = [];
                this.asteroids = [];
                
                // راه‌اندازی مجدد
                this.setupGameWorld();
                this.startGame();
            }

            showMainMenu() {
                this.gameState = 'menu';
                this.currentScreen = 'mainMenu';
                this.hideAllScreens();
                document.getElementById('mainMenu').classList.remove('hidden');
            }

            hideAllScreens() {
                const screens = document.querySelectorAll('.screen, #gameHUD');
                screens.forEach(screen => {
                    screen.classList.add('hidden');
                });
            }

            togglePause() {
                if (this.gameState === 'playing') {
                    this.gameState = 'paused';
                } else if (this.gameState === 'paused') {
                    this.gameState = 'playing';
                }
            }

            updateHUD() {
                document.getElementById('healthValue').textContent = Math.max(0, this.player.health);
                document.getElementById('shieldValue').textContent = Math.max(0, this.player.shield);
                document.getElementById('scoreValue').textContent = this.score;
                document.getElementById('levelValue').textContent = this.level;
                document.getElementById('enemiesValue').textContent = this.enemies.length;
                document.getElementById('ammoValue').textContent = this.ammo;
                document.getElementById('weaponName').textContent = this.getWeaponName(this.player.currentWeapon);
                
                document.getElementById('healthFill').style.width = this.player.health + '%';
                document.getElementById('shieldFill').style.width = this.player.shield + '%';
            }

            getWeaponName(weaponType) {
                const names = {
                    'laser': 'لیزر پایه',
                    'plasma': 'پلاسما',
                    'railgun': 'ریلگان',
                    'quantum': 'کوانتوم'
                };
                return names[weaponType] || 'نامعلوم';
            }

            setupAudio() {
                // سیستم صوتی ساده
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // می‌توانید افکت‌های صوتی اضافه کنید
            }

            playSound(frequency, duration, type = 'sine') {
                if (!this.settings.sound) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log('خطا در پخش صدا:', e);
                }
            }

            gameLoop() {
                const deltaTime = this.clock.getDelta();
                
                if (this.gameState === 'playing') {
                    this.updateGame(deltaTime);
                }
                
                this.renderer.render(this.scene, this.camera);
                requestAnimationFrame(() => this.gameLoop());
            }

            updateGame(deltaTime) {
                if (!this.player) return;
                
                this.updatePlayer(deltaTime);
                this.updateBullets(deltaTime);
                this.updateEnemies(deltaTime);
                this.updateParticles(deltaTime);
                this.updatePowerUps(deltaTime);
                this.updateAsteroids(deltaTime);
                
                this.waveManager.update(deltaTime);
                
                // آپدیت دوربین (دنبال کردن بازیکن)
                this.camera.position.x = THREE.MathUtils.lerp(this.camera.position.x, this.player.mesh.position.x, 0.1);
                this.camera.position.y = THREE.MathUtils.lerp(this.camera.position.y, this.player.mesh.position.y + 3, 0.1);
                this.camera.position.z = this.player.mesh.position.z + 10;
                
                this.camera.lookAt(this.player.mesh.position);
            }
        }

        // مدیر موج‌های دشمنان
        class WaveManager {
            constructor(game) {
                this.game = game;
                this.currentWave = 0;
                this.enemiesSpawned = 0;
                this.enemiesToSpawn = 0;
                this.waveActive = false;
                this.spawnTimer = 0;
            }

            startWave(waveNumber) {
                this.currentWave = waveNumber;
                this.enemiesSpawned = 0;
                this.enemiesToSpawn = this.calculateEnemiesCount(waveNumber);
                this.waveActive = true;
                this.spawnTimer = 0;
                
                console.log(`شروع موج ${waveNumber} - ${this.enemiesToSpawn} دشمن`);
            }

            calculateEnemiesCount(wave) {
                return Math.floor(5 + wave * 2 + Math.pow(wave, 1.5));
            }

            update(deltaTime) {
                if (!this.waveActive) return;
                
                this.spawnTimer += deltaTime;
                
                // اسپاون دشمنان با تاخیر
                if (this.spawnTimer >= 1.0 && this.enemiesSpawned < this.enemiesToSpawn) {
                    this.spawnEnemy();
                    this.spawnTimer = 0;
                }
                
                // بررسی پایان موج
                if (this.enemiesSpawned >= this.enemiesToSpawn && this.game.enemies.length === 0) {
                    this.waveComplete();
                }
            }

            spawnEnemy() {
                const wave = this.currentWave;
                let enemyType = 'scout';
                
                // تعیین نوع دشمن بر اساس موج
                if (wave >= 3 && Math.random() < 0.3) enemyType = 'fighter';
                if (wave >= 5 && Math.random() < 0.2) enemyType = 'cruiser';
                if (wave >= 8 && Math.random() < 0.1) enemyType = 'boss';
                if (wave >= 10 && Math.random() < 0.05) enemyType = 'boss';
                
                this.game.createEnemy(enemyType);
                this.enemiesSpawned++;
            }

            waveComplete() {
                this.waveActive = false;
                this.game.level = this.currentWave;
                this.game.score += this.currentWave * 100;
                
                // ایجاد آیتم پاداش
                this.game.createPowerUp(new THREE.Vector3(0, 0, 5));
                
                console.log(`موج ${this.currentWave} کامل شد!`);
                
                // شروع موج بعدی پس از تاخیر
                setTimeout(() => {
                    this.startWave(this.currentWave + 1);
                }, 3000);
            }
        }

        // راه‌اندازی بازی
        window.addEventListener('load', () => {
            const game = new SpaceWarGame();
            window.game = game; // برای دیباگ
            console.log('🎮 بازی نبرد کهکشانی بارگذاری شد!');
        });
    </script>
</body>
</html>
