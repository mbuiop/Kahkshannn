<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بازی کلش سه‌بعدی</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }
        
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 18px;
            text-align: center;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .controls-info {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0 20px;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas" touch-action="none"></canvas>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">در حال بارگذاری دیوار چین...</div>
    </div>

    <div class="controls-info" id="controlsInfo" style="display: none;">
        برای چرخش: دو انگشت بکشید | برای زوم: دو انگشت جمع/باز کنید
    </div>

    <!-- فایل‌های اسکریپت بازی -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    
    <!-- اسکریپت اصلی -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('renderCanvas');
            const engine = new BABYLON.Engine(canvas, true, {
                adaptToDeviceRatio: true
            });
            const loadingOverlay = document.getElementById('loadingOverlay');
            const controlsInfo = document.getElementById('controlsInfo');
            
            let scene;
            const filePositions = [];

            // ایجاد صحنه بازی برای موبایل
            function createScene() {
                const scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color4(0.05, 0.1, 0.15, 1.0);
                
                // دوربین برای موبایل
                const camera = new BABYLON.ArcRotateCamera(
                    "camera", 
                    -Math.PI / 2, 
                    Math.PI / 2.3, 
                    120,
                    new BABYLON.Vector3(0, 0, 0), 
                    scene
                );
                
                // تنظیمات لمسی برای موبایل
                camera.inputs.attached.pointers.touchEnabled = true;
                camera.inputs.attached.pointers.buttons = [0, 1, 2];
                camera.attachControl(canvas, true);
                
                camera.lowerRadiusLimit = 80;
                camera.upperRadiusLimit = 200;
                camera.wheelPrecision = 80;
                camera.pinchPrecision = 80;
                
                // نورپردازی ملایم
                const light = new BABYLON.HemisphericLight(
                    "light", 
                    new BABYLON.Vector3(0, 1, 0), 
                    scene
                );
                light.intensity = 0.8;
                light.groundColor = new BABYLON.Color3(0.3, 0.3, 0.5);
                
                // نور جهت‌دار ملایم
                const directionalLight = new BABYLON.DirectionalLight(
                    "directionalLight", 
                    new BABYLON.Vector3(-0.5, -1, -0.5), 
                    scene
                );
                directionalLight.intensity = 0.4;
                
                // ایجاد زمین
                const ground = BABYLON.MeshBuilder.CreateGround(
                    "ground", 
                    {width: 400, height: 400}, 
                    scene
                );
                
                // متریال زمین - گرادینت سبز
                const groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
                groundMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.4, 0.15);
                groundMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
                ground.material = groundMaterial;
                
                // ایجاد دیوار چین
                createGreatWall(scene);
                
                return scene;
            }
            
            // ایجاد دیوار چین
            function createGreatWall(scene) {
                const wallHeight = 20;
                const wallThickness = 12;
                const wallLength = 350;
                
                // رنگ‌های دیوار
                const wallColors = [
                    new BABYLON.Color3(0.5, 0.35, 0.2),  // قهوه‌ای طلایی
                    new BABYLON.Color3(0.45, 0.3, 0.15), // قهوه‌ای تیره
                    new BABYLON.Color3(0.4, 0.25, 0.1)   // قهوه‌ای بسیار تیره
                ];
                
                // دیوار شمالی
                const northWall = BABYLON.MeshBuilder.CreateBox(
                    "northWall", 
                    {width: wallLength, height: wallHeight, depth: wallThickness}, 
                    scene
                );
                northWall.position = new BABYLON.Vector3(0, wallHeight/2, wallLength/2 - 25);
                
                // دیوار جنوبی
                const southWall = BABYLON.MeshBuilder.CreateBox(
                    "southWall", 
                    {width: wallLength, height: wallHeight, depth: wallThickness}, 
                    scene
                );
                southWall.position = new BABYLON.Vector3(0, wallHeight/2, -wallLength/2 + 25);
                
                // دیوار شرقی
                const eastWall = BABYLON.MeshBuilder.CreateBox(
                    "eastWall", 
                    {width: wallThickness, height: wallHeight, depth: wallLength}, 
                    scene
                );
                eastWall.position = new BABYLON.Vector3(wallLength/2 - 25, wallHeight/2, 0);
                
                // دیوار غربی
                const westWall = BABYLON.MeshBuilder.CreateBox(
                    "westWall", 
                    {width: wallThickness, height: wallHeight, depth: wallLength}, 
                    scene
                );
                westWall.position = new BABYLON.Vector3(-wallLength/2 + 25, wallHeight/2, 0);
                
                // اعمال متریال به دیوارها
                [northWall, southWall, eastWall, westWall].forEach((wall, index) => {
                    const wallMaterial = new BABYLON.StandardMaterial(`wallMaterial${index}`, scene);
                    wallMaterial.diffuseColor = wallColors[index % wallColors.length];
                    wall.material = wallMaterial;
                });
                
                // ایجاد 4 مربع در چهار گوشه داخلی دیوار
                createInnerSquares(scene);
                
                // ایجاد برج‌های دیده‌بانی
                createWatchTowers(scene);
            }
            
            // ایجاد 4 مربع در گوشه‌های داخلی
            function createInnerSquares(scene) {
                const squareSize = 25;
                const squareHeight = 8;
                const offset = 120;
                
                const squarePositions = [
                    {x: -offset, z: -offset, color: new BABYLON.Color3(0.8, 0.2, 0.2)}, // قرمز - جنوب غربی
                    {x: offset, z: -offset, color: new BABYLON.Color3(0.2, 0.8, 0.2)},  // سبز - جنوب شرقی
                    {x: -offset, z: offset, color: new BABYLON.Color3(0.2, 0.2, 0.8)},  // آبی - شمال غربی
                    {x: offset, z: offset, color: new BABYLON.Color3(0.8, 0.8, 0.2)}    // زرد - شمال شرقی
                ];
                
                squarePositions.forEach((pos, index) => {
                    const square = BABYLON.MeshBuilder.CreateBox(
                        `innerSquare${index}`, 
                        {width: squareSize, height: squareHeight, depth: squareSize}, 
                        scene
                    );
                    square.position = new BABYLON.Vector3(pos.x, squareHeight/2, pos.z);
                    
                    const squareMaterial = new BABYLON.StandardMaterial(`squareMaterial${index}`, scene);
                    squareMaterial.diffuseColor = pos.color;
                    squareMaterial.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
                    square.material = squareMaterial;
                    
                    // اضافه کردن نور به مربع‌ها
                    const squareLight = new BABYLON.PointLight(
                        `squareLight${index}`,
                        new BABYLON.Vector3(pos.x, 15, pos.z),
                        scene
                    );
                    squareLight.diffuse = pos.color;
                    squareLight.specular = pos.color;
                    squareLight.intensity = 0.3;
                    squareLight.range = 40;
                });
            }
            
            // ایجاد برج‌های دیده‌بانی
            function createWatchTowers(scene) {
                const positions = [
                    {x: 150, z: 150}, {x: -150, z: 150},
                    {x: 150, z: -150}, {x: -150, z: -150}
                ];
                
                positions.forEach((pos, index) => {
                    // پایه برج
                    const tower = BABYLON.MeshBuilder.CreateCylinder(
                        `tower${index}`, 
                        {diameterTop: 8, diameterBottom: 12, height: 25, tessellation: 8}, 
                        scene
                    );
                    tower.position = new BABYLON.Vector3(pos.x, 12.5, pos.z);
                    
                    const towerMaterial = new BABYLON.StandardMaterial("towerMaterial", scene);
                    towerMaterial.diffuseColor = new BABYLON.Color3(0.4, 0.3, 0.2);
                    tower.material = towerMaterial;
                });
            }
            
            // ایجاد موقعیت‌های فایل‌ها
            function createFilePositions(scene) {
                const positions = [];
                const gridSize = 3;
                const spacing = 40;
                const startX = -spacing;
                const startZ = -20;
                
                // ایجاد 9 موقعیت برای فایل‌ها (3x3)
                for (let row = 0; row < gridSize; row++) {
                    for (let col = 0; col < gridSize; col++) {
                        const fileNumber = row * gridSize + col + 1;
                        const x = startX + col * spacing;
                        const z = startZ + row * spacing;
                        
                        positions.push({
                            x: x,
                            z: z,
                            fileNumber: fileNumber,
                            loaded: false,
                            buildingData: createFileBuilding(x, z, fileNumber, scene)
                        });
                    }
                }
                
                return positions;
            }
            
            // ایجاد ساختمان فایل
            function createFileBuilding(x, z, fileNumber, scene) {
                const height = 12 + Math.random() * 6;
                const building = BABYLON.MeshBuilder.CreateBox(
                    `fileBuilding${fileNumber}`, 
                    {width: 8, height: height, depth: 8}, 
                    scene
                );
                building.position = new BABYLON.Vector3(x, height/2, z);
                
                const buildingMaterial = new BABYLON.StandardMaterial(`fileBuildingMaterial${fileNumber}`, scene);
                buildingMaterial.diffuseColor = new BABYLON.Color3(0.6, 0.6, 0.6);
                building.material = buildingMaterial;
                
                // ایجاد متن فایل
                createFileText(x, z, fileNumber, scene, height);
                
                return { building, material: buildingMaterial };
            }
            
            // ایجاد متن فایل
            function createFileText(x, z, fileNumber, scene, buildingHeight) {
                const dynamicTexture = new BABYLON.DynamicTexture(`dynamicTexture${fileNumber}`, {
                    width: 256,
                    height: 128
                }, scene, false);
                
                const ctx = dynamicTexture.getContext();
                ctx.font = "bold 40px Arial";
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.fillText(`m${fileNumber}`, 128, 70);
                
                dynamicTexture.update();
                
                const plane = BABYLON.MeshBuilder.CreatePlane(`textPlane${fileNumber}`, {
                    width: 15,
                    height: 6
                }, scene);
                
                plane.position = new BABYLON.Vector3(x, buildingHeight + 4, z);
                plane.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
                
                const textMaterial = new BABYLON.StandardMaterial(`textMaterial${fileNumber}`, scene);
                textMaterial.diffuseTexture = dynamicTexture;
                textMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
                textMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.2, 0.2);
                plane.material = textMaterial;
            }
            
            // بارگذاری فایل‌ها
            function loadAndExecuteFiles() {
                let currentIndex = 0;
                
                function loadNextFile() {
                    if (currentIndex >= filePositions.length) {
                        console.log("✅ تمام فایل‌ها بارگذاری شدند!");
                        return;
                    }
                    
                    const position = filePositions[currentIndex];
                    const fileNumber = position.fileNumber;
                    
                    const script = document.createElement('script');
                    script.src = `m${fileNumber}.js`;
                    
                    script.onload = function() {
                        position.loaded = true;
                        if (position.buildingData) {
                            position.buildingData.material.diffuseColor = new BABYLON.Color3(0.2, 0.8, 0.3);
                        }
                        currentIndex++;
                        setTimeout(loadNextFile, 400);
                    };
                    
                    script.onerror = function() {
                        position.loaded = false;
                        if (position.buildingData) {
                            position.buildingData.material.diffuseColor = new BABYLON.Color3(0.9, 0.2, 0.2);
                        }
                        currentIndex++;
                        setTimeout(loadNextFile, 400);
                    };
                    
                    document.head.appendChild(script);
                }
                
                loadNextFile();
            }
            
            // راه‌اندازی بازی
            function initialize() {
                scene = createScene();
                filePositions.length = 0;
                filePositions.push(...createFilePositions(scene));
                
                setTimeout(() => {
                    loadAndExecuteFiles();
                }, 1500);
            }
            
            // شروع بازی
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    controlsInfo.style.display = 'block';
                    initialize();
                }, 500);
            }, 2500);
            
            // رندر حلقه
            engine.runRenderLoop(function() {
                if (scene) {
                    scene.render();
                }
            });
            
            // تنظیم ریسایز برای موبایل
            window.addEventListener('resize', function() {
                engine.resize();
            });
        });
    </script>
</body>
</html>
