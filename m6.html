<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§¾ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± - Ø³ÛŒØ³ØªÙ… Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #00b894;
            --primary-dark: #00a085;
            --secondary: #2d3436;
            --accent: #0984e3;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
            --purple: #9b59b6;
            --orange: #e67e22;
            --teal: #1abc9c;
            --dark: #2d3436;
            --light: #dfe6e9;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --rainbow: linear-gradient(90deg, #ff7675, #fd79a8, #74b9ff, #55efc4, #ffeaa7, #ff7675);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 40px);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--gradient);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            font-weight: 800;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .form-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
        }

        .form-title {
            font-size: 1.2em;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--dark);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: #fafafa;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }

        .btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 800;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 184, 148, 0.4);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--rainbow);
            background-size: 200% 100%;
            animation: rainbow-loading 1.5s linear infinite;
        }

        @keyframes rainbow-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple), #8e44ad);
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.3);
        }

        .btn-purple:hover {
            box-shadow: 0 8px 20px rgba(142, 68, 173, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }

        .success-message {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
            animation: slideIn 0.5s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .invoice-items {
            margin: 20px 0;
        }

        .invoice-item-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
        }

        .item-row-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.9em;
            padding: 0 10px;
        }

        .item-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .control-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .control-btn.add {
            background: var(--success);
            color: white;
        }

        .control-btn.remove {
            background: var(--danger);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .signature-pad-container {
            margin: 20px 0;
        }

        .signature-pad {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            margin-bottom: 12px;
            height: 200px;
            width: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .invoice-preview {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: none;
            position: relative;
        }

        .invoice-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--gradient);
            border-radius: 15px 15px 0 0;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary);
        }

        .invoice-title {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .invoice-number {
            font-size: 1.1em;
            color: #7f8c8d;
            font-weight: 700;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .invoice-party {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .party-title {
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 1.1em;
        }

        .invoice-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .invoice-items-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 800;
            font-size: 0.9em;
        }

        .invoice-items-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .invoice-items-table tr:last-child td {
            border-bottom: none;
        }

        .invoice-items-table tr:hover {
            background: #f8f9fa;
        }

        .invoice-totals {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .total-row:last-child {
            border-bottom: none;
            font-weight: 800;
            font-size: 1.1em;
            color: var(--primary);
        }

        .total-label {
            font-weight: 700;
            color: var(--dark);
        }

        .total-value {
            font-weight: 800;
            color: var(--dark);
        }

        .invoice-signatures {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }

        .signature-box {
            text-align: center;
        }

        .signature-title {
            font-weight: 800;
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1em;
        }

        .signature-image {
            max-width: 250px;
            max-height: 100px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }

        .signature-line {
            border-top: 2px solid #333;
            margin-top: 60px;
            padding-top: 8px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .download-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .template-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 700;
            font-size: 0.85em;
        }

        .template-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .template-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .company-logo-preview {
            max-width: 150px;
            max-height: 80px;
            margin: 10px auto;
            display: block;
            border: 1px dashed #e0e0e0;
            border-radius: 8px;
            padding: 5px;
        }

        .watermark {
            position: absolute;
            opacity: 0.1;
            font-size: 120px;
            font-weight: 900;
            color: var(--primary);
            transform: rotate(-45deg);
            pointer-events: none;
            z-index: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1em;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                min-height: calc(100vh - 20px);
                border-radius: 15px;
            }
            
            .content {
                padding: 15px;
            }
            
            .form-container {
                padding: 15px;
            }
            
            .item-row-header {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .invoice-details {
                grid-template-columns: 1fr;
            }
            
            .invoice-signatures {
                grid-template-columns: 1fr;
            }
            
            .download-options {
                grid-template-columns: 1fr;
            }
            
            .template-selector {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .back-btn {
                top: 15px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.9em;
            }
            
            .invoice-preview {
                padding: 20px;
            }
            
            .invoice-title {
                font-size: 1.4em;
            }
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾ */
        @media print {
            body * {
                visibility: hidden;
            }
            .invoice-preview,
            .invoice-preview * {
                visibility: visible;
            }
            .invoice-preview {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .download-options {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">
                <span>â†</span> Ø¨Ø§Ø²Ú¯Ø´Øª
            </a>
            <h1>ğŸ§¾ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</h1>
            <p>Ø·Ø±Ø§Ø­ÛŒ Ùˆ ØµØ¯ÙˆØ± ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</p>
        </div>

        <div class="content">
            <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ -->
            <div class="form-container">
                <h2 class="form-title">ğŸ¨ Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±</h2>
                <div class="template-selector">
                    <div class="template-option active" onclick="selectTemplate('modern')">
                        ğŸš€ Ù…Ø¯Ø±Ù†
                    </div>
                    <div class="template-option" onclick="selectTemplate('classic')">
                        ğŸ“œ Ú©Ù„Ø§Ø³ÛŒÚ©
                    </div>
                    <div class="template-option" onclick="selectTemplate('minimal')">
                        âš¡ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„
                    </div>
                </div>
            </div>

            <!-- ÙØ±Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ± -->
            <div class="form-container">
                <h2 class="form-title">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±</h2>
                
                <div class="form-group">
                    <label for="invoice-type">Ù†ÙˆØ¹ ÙØ§Ú©ØªÙˆØ±:</label>
                    <select id="invoice-type">
                        <option value="sale">ÙØ±ÙˆØ´</option>
                        <option value="purchase">Ø®Ø±ÛŒØ¯</option>
                        <option value="proforma">Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±</option>
                        <option value="official">Ø±Ø³Ù…ÛŒ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-logo">Ù„ÙˆÚ¯Ùˆ Ø´Ø±Ú©Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                    <input type="file" id="invoice-logo" accept="image/*" onchange="previewLogo(event)">
                    <img id="logo-preview" class="company-logo-preview" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="invoice-seller">ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="invoice-seller" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡">
                </div>

                <div class="form-group">
                    <label for="invoice-seller-info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <textarea id="invoice-seller-info" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§Ù†Ú©ÛŒ"></textarea>
                </div>

                <div class="form-group">
                    <label for="invoice-buyer">Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="invoice-buyer" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®Ø±ÛŒØ¯Ø§Ø±">
                </div>

                <div class="form-group">
                    <label for="invoice-buyer-info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <textarea id="invoice-buyer-info" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³"></textarea>
                </div>

                <div class="form-group">
                    <label for="invoice-date">ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="date" id="invoice-date">
                </div>

                <div class="form-group">
                    <label for="invoice-due-date">ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                    <input type="date" id="invoice-due-date">
                </div>

                <div class="form-group">
                    <label for="invoice-notes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±:</label>
                    <textarea id="invoice-notes" rows="3" placeholder="Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®ØªØŒ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ"></textarea>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ± -->
            <div class="form-container">
                <h2 class="form-title">ğŸ›ï¸ Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±</h2>
                
                <div class="invoice-items">
                    <div class="item-row-header">
                        <div>Ù†Ø§Ù… Ú©Ø§Ù„Ø§/Ø®Ø¯Ù…Øª</div>
                        <div>ØªØ¹Ø¯Ø§Ø¯</div>
                        <div>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</div>
                        <div>Ø¬Ù…Ø¹</div>
                        <div>Ø¹Ù…Ù„ÛŒØ§Øª</div>
                    </div>
                    
                    <div id="invoice-items-container">
                        <!-- Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ± Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                </div>

                <button type="button" class="control-btn add" onclick="addInvoiceItem()">
                    <span>â•</span> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§
                </button>
            </div>

            <!-- Ø¨Ø®Ø´ Ø§Ù…Ø¶Ø§ -->
            <div class="form-container">
                <h2 class="form-title">âœï¸ Ø§Ù…Ø¶Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„</h2>
                
                <div class="signature-pad-container">
                    <label>Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <canvas class="signature-pad" id="signature-pad"></canvas>
                    
                    <div class="signature-controls">
                        <button type="button" class="control-btn remove" onclick="clearSignature()">
                            <span>ğŸ—‘ï¸</span> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§
                        </button>
                        <button type="button" class="control-btn add" onclick="undoSignature()">
                            <span>â†¶</span> Ø¨Ø§Ø²Ú¯Ø´Øª
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="invoice-terms">Ø´Ø±Ø§ÛŒØ· Ùˆ Ø¶ÙˆØ§Ø¨Ø·:</label>
                    <textarea id="invoice-terms" rows="3" placeholder="Ø´Ø±Ø§ÛŒØ· Ø¹Ù…ÙˆÙ…ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ØŒ Ø¶Ù…Ø§Ù†Øªâ€ŒÙ‡Ø§ Ùˆ ...">1. Ú©Ù„ÛŒÙ‡ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¯Ø§Ø±Ø§ÛŒ Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ù†Ø¯.
2. Ù…Ù‡Ù„Øª Ø¨Ø§Ø²Ú¯Ø´Øª Ú©Ø§Ù„Ø§ 7 Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯.
3. Ù…Ø³Ø¦ÙˆÙ„ÛŒØª Ø­Ù…Ù„ Ùˆ Ù†Ù‚Ù„ Ø¨Ù‡ Ø¹Ù‡Ø¯Ù‡ Ø®Ø±ÛŒØ¯Ø§Ø± Ø§Ø³Øª.</textarea>
                </div>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± -->
            <button class="btn btn-purple" onclick="generateInvoice()">
                <span>ğŸ§¾</span> Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
            </button>

            <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± -->
            <div class="invoice-preview" id="invoice-preview">
                <div class="watermark" id="watermark">FACTURE</div>
                
                <div class="invoice-header">
                    <div class="invoice-title" id="preview-title">ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´</div>
                    <div class="invoice-number" id="preview-number">Ø´Ù…Ø§Ø±Ù‡: #INV-0001</div>
                </div>

                <div class="invoice-details">
                    <div class="invoice-party">
                        <div class="party-title">ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</div>
                        <div id="preview-seller">Ù†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        <div id="preview-seller-info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                    </div>
                    
                    <div class="invoice-party">
                        <div class="party-title">Ø®Ø±ÛŒØ¯Ø§Ø±:</div>
                        <div id="preview-buyer">Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div id="preview-buyer-info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                    </div>
                </div>

                <table class="invoice-items-table" id="preview-items-table">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§/Ø®Ø¯Ù…Øª</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)</th>
                        </tr>
                    </thead>
                    <tbody id="preview-items-body">
                        <!-- Ø§Ù‚Ù„Ø§Ù… Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </tbody>
                </table>

                <div class="invoice-totals">
                    <div class="total-row">
                        <span class="total-label">Ø¬Ù…Ø¹ Ú©Ù„:</span>
                        <span class="total-value" id="preview-subtotal">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">ØªØ®ÙÛŒÙ:</span>
                        <span class="total-value" id="preview-discount">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Ù…Ø§Ù„ÛŒØ§Øª (Û¹Ùª):</span>
                        <span class="total-value" id="preview-tax">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span class="total-value" id="preview-total">0 ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>

                <div id="preview-notes" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;"></div>

                <div class="invoice-signatures">
                    <div class="signature-box">
                        <div class="signature-title">Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        <img id="preview-signature" class="signature-image" style="display: none;">
                        <div class="signature-line">Ø§Ù…Ø¶Ø§</div>
                    </div>
                    
                    <div class="signature-box">
                        <div class="signature-title">Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div class="signature-line">Ø§Ù…Ø¶Ø§</div>
                    </div>
                </div>

                <!-- Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ -->
                <div class="download-options">
                    <button class="btn btn-success" onclick="downloadInvoiceAsPDF()">
                        <span>ğŸ“¥</span> Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF
                    </button>
                    <button class="btn btn-purple" onclick="downloadInvoiceAsImage()">
                        <span>ğŸ–¼ï¸</span> Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³
                    </button>
                    <button class="btn" onclick="printInvoice()" style="grid-column: 1 / -1;">
                        <span>ğŸ–¨ï¸</span> Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                    </button>
                </div>
            </div>

            <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ -->
            <div class="form-container">
                <h2 class="form-title">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§</h2>
                <div id="invoices-history">
                    <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // # Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let signaturePad = null;
        let currentTemplate = 'modern';
        let companyLogo = null;

        // # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡
        window.onload = function() {
            initializeSignaturePad();
            renderInvoicesHistory();
            
            // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoice-date').value = today;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛŒÚ© Ø±Ø¯ÛŒÙ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            addInvoiceItem();
        };

        // # Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨
        function selectTemplate(template) {
            currentTemplate = template;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¸Ø§Ù‡Ø± Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ØªØºÛŒÛŒØ± ÙˆØ§ØªØ±Ù…Ø§Ø±Ú©
            const watermark = document.getElementById('watermark');
            switch(template) {
                case 'modern':
                    watermark.textContent = 'FACTURE';
                    watermark.style.color = '#00b894';
                    break;
                case 'classic':
                    watermark.textContent = 'INVOICE';
                    watermark.style.color = '#8e44ad';
                    break;
                case 'minimal':
                    watermark.textContent = 'BILL';
                    watermark.style.color = '#0984e3';
                    break;
            }
        }

        // # Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù„ÙˆÚ¯Ùˆ
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    companyLogo = e.target.result;
                    const preview = document.getElementById('logo-preview');
                    preview.src = companyLogo;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // # Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ú©Ø§Ù„Ø§
        function addInvoiceItem() {
            const container = document.getElementById('invoice-items-container');
            const itemId = Date.now();
            
            const itemRow = document.createElement('div');
            itemRow.className = 'invoice-item-row';
            itemRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                    <input type="text" class="item-name" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ ÛŒØ§ Ø®Ø¯Ù…Øª" onchange="calculateItemTotal(this)">
                    <input type="number" class="item-quantity" placeholder="ØªØ¹Ø¯Ø§Ø¯" value="1" min="1" onchange="calculateItemTotal(this)">
                    <input type="number" class="item-price" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" onchange="calculateItemTotal(this)">
                    <input type="text" class="item-total" placeholder="0" readonly style="background: #e9ecef; font-weight: 700;">
                    <div class="item-controls">
                        <button type="button" class="control-btn remove" onclick="removeInvoiceItem(this)">
                            <span>âœ•</span>
                        </button>
                    </div>
                </div>
                <div style="margin-top: 8px;">
                    <input type="text" class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" style="width: 100%; font-size: 0.9em;">
                </div>
            `;
            
            container.appendChild(itemRow);
        }

        // # Ø­Ø°Ù Ø±Ø¯ÛŒÙ Ú©Ø§Ù„Ø§
        function removeInvoiceItem(button) {
            button.closest('.invoice-item-row').remove();
        }

        // # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ù…Ø¹ Ù‡Ø± Ø±Ø¯ÛŒÙ
        function calculateItemTotal(input) {
            const row = input.closest('.invoice-item-row');
            const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
            const price = parseInt(row.querySelector('.item-price').value) || 0;
            const total = quantity * price;
            
            row.querySelector('.item-total').value = total.toLocaleString();
        }

        // # Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù¾Ø¯ Ø§Ù…Ø¶Ø§
        function initializeSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (canvas) {
                signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'white',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3
                });
                
                // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§ÛŒØ² Ú©Ø§Ù†ÙˆØ§Ø³
                canvas.style.width = '100%';
                canvas.style.height = '200px';
            }
        }

        // # Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§
        function clearSignature() {
            if (signaturePad) {
                signaturePad.clear();
            }
        }

        // # Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø± Ø§Ù…Ø¶Ø§
        function undoSignature() {
            if (signaturePad) {
                const data = signaturePad.toData();
                if (data) {
                    data.pop(); // Ø­Ø°Ù Ø¢Ø®Ø±ÛŒÙ† Ø®Ø·
                    signaturePad.fromData(data);
                }
            }
        }

        // # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±
        function generateInvoice() {
            const button = event.target;
            addLoading(button);
            
            setTimeout(() => {
                const type = document.getElementById('invoice-type').value;
                const seller = document.getElementById('invoice-seller').value;
                const sellerInfo = document.getElementById('invoice-seller-info').value;
                const buyer = document.getElementById('invoice-buyer').value;
                const buyerInfo = document.getElementById('invoice-buyer-info').value;
                const date = document.getElementById('invoice-date').value;
                const dueDate = document.getElementById('invoice-due-date').value;
                const notes = document.getElementById('invoice-notes').value;
                const terms = document.getElementById('invoice-terms').value;
                
                if (!seller || !buyer) { 
                    showErrorMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); 
                    return; 
                }
                
                // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±
                const items = [];
                let subtotal = 0;
                
                document.querySelectorAll('.invoice-item-row').forEach((row, index) => {
                    const name = row.querySelector('.item-name').value;
                    const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                    const price = parseInt(row.querySelector('.item-price').value) || 0;
                    const description = row.querySelector('.item-description').value;
                    
                    if (name && quantity > 0 && price > 0) {
                        const itemTotal = quantity * price;
                        subtotal += itemTotal;
                        
                        items.push({
                            id: index + 1,
                            name,
                            quantity,
                            price,
                            total: itemTotal,
                            description
                        });
                    }
                });
                
                if (items.length === 0) { 
                    showErrorMessage('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯'); 
                    return; 
                }
                
                // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒ
                const discount = 0; // Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
                const tax = Math.round(subtotal * 0.09); // Ù…Ø§Ù„ÛŒØ§Øª 9%
                const total = subtotal - discount + tax;
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…Ø¶Ø§
                let signatureData = null;
                if (signaturePad && !signaturePad.isEmpty()) {
                    signatureData = signaturePad.toDataURL();
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                showInvoicePreview({
                    type,
                    seller,
                    sellerInfo,
                    buyer,
                    buyerInfo,
                    date,
                    dueDate,
                    notes,
                    terms,
                    items,
                    subtotal,
                    discount,
                    tax,
                    total,
                    signature: signatureData,
                    logo: companyLogo
                });
                
                // Ø°Ø®ÛŒØ±Ù‡ ÙØ§Ú©ØªÙˆØ±
                const invoice = {
                    id: Date.now(),
                    number: `INV-${Date.now().toString().slice(-6)}`,
                    type,
                    seller,
                    sellerInfo,
                    buyer,
                    buyerInfo,
                    date,
                    dueDate,
                    notes,
                    terms,
                    items,
                    subtotal,
                    discount,
                    tax,
                    total,
                    signature: signatureData,
                    logo: companyLogo,
                    template: currentTemplate,
                    created: new Date().toISOString()
                };
                
                invoices.unshift(invoice);
                saveInvoices();
                renderInvoicesHistory();
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                
            }, 1000);
        }

        // # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
        function showInvoicePreview(data) {
            // ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ
            document.getElementById('preview-title').textContent = getInvoiceTypeName(data.type);
            document.getElementById('preview-number').textContent = `Ø´Ù…Ø§Ø±Ù‡: #INV-${data.id.toString().slice(-6)}`;
            document.getElementById('preview-seller').textContent = data.seller;
            document.getElementById('preview-seller-info').textContent = data.sellerInfo;
            document.getElementById('preview-buyer').textContent = data.buyer;
            document.getElementById('preview-buyer-info').textContent = data.buyerInfo;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ù‚Ù„Ø§Ù…
            const itemsBody = document.getElementById('preview-items-body');
            itemsBody.innerHTML = '';
            
            data.items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>
                        <div style="font-weight: 700;">${item.name}</div>
                        ${item.description ? `<div style="font-size: 0.8em; color: #7f8c8d;">${item.description}</div>` : ''}
                    </td>
                    <td>${item.quantity.toLocaleString()}</td>
                    <td>${item.price.toLocaleString()}</td>
                    <td style="font-weight: 700;">${item.total.toLocaleString()}</td>
                `;
                itemsBody.appendChild(row);
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ù…Ø¨Ø§Ù„Øº
            document.getElementById('preview-subtotal').textContent = data.subtotal.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('preview-discount').textContent = data.discount.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('preview-tax').textContent = data.tax.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            document.getElementById('preview-total').textContent = data.total.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
            
            // Ù†Ù…Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§
            const notesContainer = document.getElementById('preview-notes');
            notesContainer.innerHTML = '';
            
            if (data.notes) {
                notesContainer.innerHTML += `<div><strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</strong> ${data.notes}</div>`;
            }
            if (data.terms) {
                notesContainer.innerHTML += `<div style="margin-top: 8px;"><strong>Ø´Ø±Ø§ÛŒØ· Ùˆ Ø¶ÙˆØ§Ø¨Ø·:</strong><br>${data.terms.replace(/\n/g, '<br>')}</div>`;
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ù…Ø¶Ø§
            const signaturePreview = document.getElementById('preview-signature');
            if (data.signature) {
                signaturePreview.src = data.signature;
                signaturePreview.style.display = 'block';
            } else {
                signaturePreview.style.display = 'none';
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            document.getElementById('invoice-preview').style.display = 'block';
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            document.getElementById('invoice-preview').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† PDF
        function downloadInvoiceAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const invoiceContent = document.getElementById('invoice-preview');
            
            addLoading(event.target);
            
            html2canvas(invoiceContent, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 190;
                const pageHeight = 290;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 10;
                
                doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                doc.save(`ÙØ§Ú©ØªÙˆØ±_${Date.now()}.pdf`);
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØµÙˆØ±Øª PDF Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ PDF:', error);
                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ PDF. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }

        // # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¹Ú©Ø³
        function downloadInvoiceAsImage() {
            const invoiceContent = document.getElementById('invoice-preview');
            
            addLoading(event.target);
            
            html2canvas(invoiceContent, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `ÙØ§Ú©ØªÙˆØ±_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³:', error);
                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø¹Ú©Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }

        // # Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
        function printInvoice() {
            window.print();
        }

        // # Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
        function renderInvoicesHistory() {
            const container = document.getElementById('invoices-history');
            container.innerHTML = '';
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“</div>
                        <p>Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                    </div>
                `;
                return;
            }
            
            invoices.forEach(invoice => {
                const invoiceEl = document.createElement('div');
                invoiceEl.className = 'invoice-item-row';
                invoiceEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 800; font-size: 1em;">${getInvoiceTypeName(invoice.type)} - ${invoice.number}</div>
                            <div style="font-size: 0.85em; color: #7f8c8d;">
                                ÙØ±ÙˆØ´Ù†Ø¯Ù‡: ${invoice.seller} | Ø®Ø±ÛŒØ¯Ø§Ø±: ${invoice.buyer}
                            </div>
                            <div style="font-size: 0.8em; color: #7f8c8d;">
                                ØªØ§Ø±ÛŒØ®: ${formatDate(invoice.date)} | Ù…Ø¨Ù„Øº: ${invoice.total.toLocaleString()} ØªÙˆÙ…Ø§Ù†
                            </div>
                        </div>
                        <div class="item-controls">
                            <button class="control-btn add" onclick="loadInvoice(${invoice.id})">
                                <span>ğŸ‘ï¸</span> Ù…Ø´Ø§Ù‡Ø¯Ù‡
                            </button>
                            <button class="control-btn remove" onclick="deleteInvoice(${invoice.id})">
                                <span>ğŸ—‘ï¸</span> Ø­Ø°Ù
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(invoiceEl);
            });
        }

        // # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§Ú©ØªÙˆØ± Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡
        function loadInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                showInvoicePreview(invoice);
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                
                // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
                document.getElementById('invoice-preview').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }

        // # Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±
        function deleteInvoice(id) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                invoices = invoices.filter(invoice => invoice.id !== id);
                saveInvoices();
                renderInvoicesHistory();
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
            }
        }

        // # ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function getInvoiceTypeName(type) {
            const types = {
                'sale': 'ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´',
                'purchase': 'ÙØ§Ú©ØªÙˆØ± Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´ ÙØ§Ú©ØªÙˆØ±',
                'official': 'ÙØ§Ú©ØªÙˆØ± Ø±Ø³Ù…ÛŒ'
            };
            return types[type] || 'ÙØ§Ú©ØªÙˆØ±';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR');
        }

        // # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        function saveInvoices() { 
            try {
                localStorage.setItem('invoices', JSON.stringify(invoices)); 
            } catch(e) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±:', e);
                showErrorMessage('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§. ÙØ¶Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.');
            }
        }

        // # Ø³ÛŒØ³ØªÙ… Ù„ÙˆØ¯ÛŒÙ†Ú¯
        function addLoading(element) {
            element.classList.add('loading');
            setTimeout(() => {
                element.classList.remove('loading');
            }, 1500);
        }

        // # Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        function showSuccessMessage(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) { existingMessage.remove(); }
            
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(successMessage, content.firstChild);
            
            setTimeout(() => { 
                if (successMessage.parentElement) { 
                    successMessage.remove(); 
                } 
            }, 4000);
        }

        // # Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
        function showErrorMessage(message) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'success-message';
            errorMessage.style.background = 'var(--danger)';
            errorMessage.textContent = message;
            
            const content = document.querySelector('.content');
            content.insertBefore(errorMessage, content.firstChild);
            
            setTimeout(() => { 
                if (errorMessage.parentElement) { 
                    errorMessage.remove(); 
                } 
            }, 4000);
        }

        // # ÙˆÛŒÚ˜Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯: Ø´Ù…Ø§Ø±Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        function generateInvoiceNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const count = invoices.filter(inv => 
                new Date(inv.created).getMonth() === today.getMonth()
            ).length + 1;
            
            return `INV-${year}${month}-${String(count).padStart(3, '0')}`;
        }

        // # ÙˆÛŒÚ˜Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù„ÛŒØ§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡
        function calculateTax(subtotal, taxRate = 9) {
            return Math.round(subtotal * taxRate / 100);
        }

        // # ÙˆÛŒÚ˜Ú¯ÛŒ Ø¬Ø¯ÛŒØ¯: Ø§Ø¹Ù…Ø§Ù„ ØªØ®ÙÛŒÙ
        function applyDiscount(subtotal, discountType, discountValue) {
            if (discountType === 'percentage') {
                return Math.round(subtotal * discountValue / 100);
            } else if (discountType === 'fixed') {
                return discountValue;
            }
            return 0;
        }
    </script>
</body>
</html>